<div class="container mx-auto p-3 sm:p-4 md:p-5">
  <!-- Stato vuoto quando non c'è progetto selezionato -->
  @if (!selectedProject()) {
  <div class="empty-state">
    <i class="pi pi-info-circle"></i>
    <h3>Nessun ristorante selezionato</h3>
    <p>
      Seleziona un ristorante dal menu in alto per visualizzare le fatture
      elettroniche.
    </p>
  </div>
  } @else {
  <!-- Header con titolo e pulsanti azione -->
  <div class="flex flex-wrap justify-between items-center mb-4">
    <h1 class="text-2xl font-bold mb-2 md:mb-0">Fatture Elettroniche</h1>
    <div class="flex flex-wrap gap-2">
      <!-- Barra di ricerca -->
      <div class="p-inputgroup">
        <input
          type="text"
          pInputText
          placeholder="Cerca fatture..."
          [(ngModel)]="searchQuery"
          (ngModelChange)="filterInvoices($event)"
        />
        <button
          *ngIf="searchQuery"
          pButton
          icon="pi pi-times"
          (click)="clearSearch()"
        ></button>
      </div>

      <button
        pButton
        pRipple
        icon="pi pi-folder-open"
        class="p-button-outlined"
        [class.p-button-info]="showWarehouseSection"
        (click)="toggleWarehouseSection()"
        pTooltip="Mostra/Nascondi magazzini"
        tooltipPosition="bottom"
      ></button>

      <button
        pButton
        pRipple
        icon="pi pi-filter"
        class="p-button-outlined"
        [class.p-button-info]="hasActiveFilters()"
        (click)="openFilterDialog()"
        pTooltip="Filtra fatture"
        tooltipPosition="bottom"
      ></button>

      <button
        pButton
        pRipple
        icon="pi pi-refresh"
        class="p-button-outlined"
        [loading]="isLoading()"
        (click)="refreshInvoices()"
        pTooltip="Aggiorna fatture"
        tooltipPosition="bottom"
      ></button>

      <button
        pButton
        pRipple
        icon="pi pi-upload"
        label="Carica Fatture"
        class="p-button-primary"
        (click)="openUploadDialog()"
        pTooltip="Carica nuove fatture"
        tooltipPosition="bottom"
      ></button>
    </div>
  </div>

  <!-- Sezione Magazzini e Centri di Costo -->
  <div *ngIf="showWarehouseSection" class="mb-5 warehouse-section">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-xl font-medium">Magazzini e Centri di Costo</h2>
      <div class="text-sm text-gray-500" *ngIf="warehouseMode === 'dropTarget'">
        Trascina le fatture sui magazzini per assegnarle
      </div>
    </div>

    <!-- Componente Warehouses e Assignment -->
    <div class="">
      <app-warehouses
        [projectId]="getSelectedProjectId()!"
        [mode]="warehouseMode"
        (onWarehouseSelected)="handleWarehouseSelected($event)"
        (onInvoiceDropped)="handleInvoiceDropped($event)"
      ></app-warehouses>

      <!-- Componente di assegnazione -->
      <app-assignment
        [projectId]="getSelectedProjectId()!"
        [suppliers]="suppliersArray()"
      ></app-assignment>
    </div>
  </div>

  <!-- Stato di caricamento -->
  <div *ngIf="isLoading()" class="flex justify-center my-5">
    <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
  </div>

  <!-- Messaggio stato vuoto -->
  <div
    *ngIf="!isLoading() && (!filteredInvoices || filteredInvoices.length === 0)"
    class="empty-state"
  >
    <i class="pi pi-file-invoice"></i>
    <h3>Nessuna fattura trovata</h3>
    <p>
      Non ci sono fatture elettroniche registrate per questo progetto o
      corrispondenti ai filtri applicati.
    </p>
    <div class="flex gap-2 justify-center mt-4">
      <button
        pButton
        pRipple
        icon="pi pi-upload"
        label="Carica Fatture"
        class="p-button-primary"
        (click)="openUploadDialog()"
      ></button>
    </div>
  </div>

  <!-- Vista fatture in grid - ora è l'unica visualizzazione disponibile -->
  <ng-container
    *ngIf="!isLoading() && filteredInvoices && filteredInvoices.length > 0"
  >
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
      <app-einvoice-view
        *ngFor="let invoice of filteredInvoices"
        [invoice]="invoice"
        [suppliers]="suppliersArray()"
        viewMode="card"
        [processingInvoiceId]="processingInvoiceId"
        [progressPercent]="progressPercent"
        (onDetails)="viewInvoiceDetails($event)"
        (onEdit)="editInvoice($event)"
        (onDelete)="handleInvoiceDelete($event)"
        (onUpdatePaymentStatus)="handleUpdatePaymentStatus($event)"
        (onDrag)="warehouseMode = 'dropTarget'"
      ></app-einvoice-view>
    </div>
  </ng-container>
  }
</div>

<!-- Dialog per caricare nuove fatture -->
<p-dialog
  header="Carica Fatture Elettroniche"
  [(visible)]="uploadDialogVisible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '650px' }"
  styleClass="upload-dialog"
>
  <app-upload
    [projectId]="getSelectedProjectId()!"
    (uploadComplete)="handleUploadComplete()"
    (uploadCanceled)="handleUploadCanceled()"
  ></app-upload>
</p-dialog>

<!-- Dialog per visualizzare dettagli fattura -->
<p-dialog
  header="Dettagli Fattura"
  [(visible)]="detailsDialogVisible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '80%', maxWidth: '900px' }"
  styleClass="details-dialog"
>
  <app-einvoice-view
    *ngIf="selectedInvoice"
    [invoice]="selectedInvoice"
    [suppliers]="suppliersArray()"
    viewMode="detail"
    (onEdit)="editInvoice($event)"
    (onDelete)="handleInvoiceDelete($event)"
    (onUpdatePaymentStatus)="handleUpdatePaymentStatus($event)"
  ></app-einvoice-view>

  <ng-template pTemplate="footer">
    <button
      pButton
      pRipple
      label="Chiudi"
      icon="pi pi-times"
      class="p-button-text"
      (click)="closeDetailsDialog()"
    ></button>
  </ng-template>
</p-dialog>

<!-- Dialog per filtri -->
<p-dialog
  header="Filtra Fatture"
  [(visible)]="filterDialogVisible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '450px' }"
  styleClass="filter-dialog"
>
  <app-einvoice-filter
    [supplierOptions]="supplierOptions"
    [filters]="filters"
    (onApplyFilters)="applyFilters($event)"
    (onResetFilters)="resetFilters()"
    (onCancel)="closeFilterDialog()"
  ></app-einvoice-filter>
</p-dialog>

<style>
  .empty-state {
    padding: 3rem 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .empty-state i {
    font-size: 3rem;
    color: #ccc;
    margin-bottom: 1rem;
  }

  .empty-state h3 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .invoice-card {
    transition: all 0.3s ease;
  }

  .invoice-card:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
      0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }

  .selected-row {
    background-color: #e3f2fd;
  }
</style>
