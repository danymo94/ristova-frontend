<div class="stock-movements-container p-3">
  <!-- Header con titolo e tipo di vista -->
  <div
    class="flex flex-column md:flex-row justify-content-between align-items-center mb-4"
  >
    <h1 class="text-2xl font-bold mb-3 md:mb-0">Movimenti di Magazzino</h1>

    <p-selectButton
      [options]="viewOptions"
      [(ngModel)]="viewType"
      optionLabel="label"
      optionValue="value"
    >
      <ng-template let-item pTemplate>
        <i [class]="item.icon" class="mr-2"></i>
        {{ item.label }}
      </ng-template>
    </p-selectButton>
  </div>

  <!-- Stato vuoto quando non c'è progetto selezionato -->
  <div *ngIf="!selectedProject()" class="empty-state text-center p-5">
    <i class="pi pi-info-circle text-6xl text-gray-400 mb-3"></i>
    <h3 class="text-xl mb-2">Nessun ristorante selezionato</h3>
    <p class="text-gray-600">
      Seleziona un ristorante dal menu in alto per visualizzare i movimenti di
      magazzino.
    </p>
  </div>

  <div *ngIf="selectedProject()" class="grid">
    <!-- Colonna sinistra: Selezione magazzino/centro di costo -->
    <div class="col-12 md:col-3">
      <div class="card p-0">
        <div class="p-3 font-bold bg-gray-100 border-bottom-1 border-gray-200">
          <span *ngIf="viewType === 'warehouse'">Magazzini</span>
          <span *ngIf="viewType === 'costcenter'">Centri di Costo</span>
        </div>
        <div class="p-0">
          <app-warehouse-selector
            [warehouses]="warehouses()"
            [loading]="isLoading()"
            [warehouseType]="
              viewType === 'warehouse' ? 'PHYSICAL' : 'COST_CENTER'
            "
            [selectedWarehouseId]="selectedWarehouse?.id"
            (warehouseSelected)="onWarehouseSelected($event)"
          ></app-warehouse-selector>
        </div>
      </div>
    </div>

    <!-- Colonna destra: Contenuto principale -->
    <div class="col-12 md:col-9">
      <!-- Quando non è stato selezionato un magazzino/centro di costo -->
      <div
        *ngIf="!hasSelectedWarehouse"
        class="card flex align-items-center justify-content-center min-h-20rem"
      >
        <div class="text-center p-5">
          <i class="pi pi-arrow-left text-5xl text-gray-400 mb-3"></i>
          <h3 class="text-xl mb-2">
            Seleziona un
            {{ viewType === "warehouse" ? "magazzino" : "centro di costo" }}
          </h3>
          <p class="text-gray-600">
            Seleziona un elemento dalla lista per visualizzarne i dettagli e i
            movimenti.
          </p>
        </div>
      </div>

      <!-- Quando è stato selezionato un magazzino/centro di costo -->
      <div *ngIf="hasSelectedWarehouse">
        <div class="card mb-3">
          <div class="flex justify-content-between align-items-center">
            <h2 class="text-xl m-0">
              <i
                *ngIf="viewType === 'warehouse'"
                class="pi pi-building mr-2"
              ></i>
              <i
                *ngIf="viewType === 'costcenter'"
                class="pi pi-chart-pie mr-2"
              ></i>
              {{ selectedWarehouse?.name }}
            </h2>
            <button
              pButton
              icon="pi pi-plus"
              label="Nuovo Movimento"
              (click)="openNewMovementDialog()"
              class="p-button-primary"
            ></button>
          </div>
        </div>

        <!-- Tab View per movimenti e inventario -->
        <p-tabView [(activeIndex)]="activeTabIndex">
          <!-- Tab Movimenti -->
          <p-tabPanel header="Movimenti">
            <div
              class="mb-3 flex flex-column md:flex-row align-items-center justify-content-between gap-3"
            >
              <!-- Filtri -->
              <div class="p-inputgroup flex-1 md:max-w-20rem">
                <span class="p-inputgroup-addon">
                  <i class="pi pi-search"></i>
                </span>
                <input
                  type="text"
                  pInputText
                  [(ngModel)]="searchQuery"
                  placeholder="Cerca movimenti..."
                  class="w-full"
                />
                <button
                  *ngIf="searchQuery"
                  pButton
                  icon="pi pi-times"
                  class="p-button-outlined"
                  (click)="searchQuery = ''; applyFilters()"
                ></button>
              </div>

              <div class="flex gap-2">
                <p-dropdown
                  [options]="movementTypeOptions"
                  [(ngModel)]="filterByType"
                  placeholder="Tipo movimento"
                  [showClear]="true"
                  optionLabel="label"
                  optionValue="value"
                  styleClass="w-10rem"
                  (onChange)="applyFilters()"
                ></p-dropdown>

                <p-dropdown
                  [options]="movementStatusOptions"
                  [(ngModel)]="filterByStatus"
                  placeholder="Stato"
                  [showClear]="true"
                  optionLabel="label"
                  optionValue="value"
                  styleClass="w-10rem"
                  (onChange)="applyFilters()"
                ></p-dropdown>

                <button
                  pButton
                  icon="pi pi-filter-slash"
                  class="p-button-outlined"
                  (click)="clearFilters()"
                  [disabled]="!filterByType && !filterByStatus && !searchQuery"
                  pTooltip="Cancella filtri"
                ></button>
              </div>
            </div>

            <!-- Lista movimenti -->
            <app-movement-list
              [movements]="stockMovements()"
              [loading]="isLoading()"
              [warehouseType]="
                viewType === 'warehouse' ? 'PHYSICAL' : 'COST_CENTER'
              "
              (movementSelected)="onMovementSelected($event)"
            ></app-movement-list>
          </p-tabPanel>

          <!-- Tab Inventario -->
          <p-tabPanel header="Inventario">
            <app-warehouse-inventory
              [warehouse]="selectedWarehouse"
              [warehouseBalance]="warehouseStore.warehouseBalance()"
              [loading]="isLoading()"
            ></app-warehouse-inventory>
          </p-tabPanel>
        </p-tabView>
      </div>
    </div>
  </div>
</div>

<!-- Dialog per nuovo movimento -->
<p-dialog
  [(visible)]="showNewMovementDialog"
  [style]="{ width: '80vw', maxWidth: '900px' }"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  header="Nuovo Movimento di Magazzino"
>
  <app-new-movement-wizard
    *ngIf="showNewMovementDialog"
    [warehouse]="selectedWarehouse"
    [warehouseType]="viewType === 'warehouse' ? 'PHYSICAL' : 'COST_CENTER'"
    (movementCreated)="onMovementCreated($event)"
    (cancel)="closeNewMovementDialog()"
  ></app-new-movement-wizard>
</p-dialog>

<!-- Dialog per dettagli movimento -->
<p-dialog
  [(visible)]="showDetailsDialog"
  [style]="{ width: '80vw', maxWidth: '900px' }"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  header="Dettagli Movimento"
>
  <app-movement-details
    *ngIf="showDetailsDialog && selectedMovement()"
    [movement]="selectedMovement()"
    [movementDetails]="stockMovementStore.movementDetails()"
    [loading]="isLoading()"
    (close)="closeDetailsDialog()"
  ></app-movement-details>
</p-dialog>

<style>
  .min-h-20rem {
    min-height: 20rem;
  }
</style>
